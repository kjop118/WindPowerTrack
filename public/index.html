<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Nunito&display=swap" rel="stylesheet" />
        <link href="../static/main.css" rel="stylesheet" />
        <link rel="shortcut icon" type="image/png" href="../static/pictures/windmill.png">

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> -->
        <!-- jQuery library -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
        <!-- Latest compiled JavaScript -->
        <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <title>Wind Power Trucker</title>
    </head>
    <body>

        <!-- <div class="background-img"> -->
           
            <div class="container">
    
                <!-- <div class="wind-speed-container">
                    <span class="wind-txt">Wind speed</span>
                    <span class="wind-value">20 m/s</span>
                </div> -->

                <div class="production-container">
                    <span class="production-txt">Todayâ€™s power production</span>
                    <span class="production-value" id="power-sum">2,14 kWh</span>
                </div>

            </div>

            <div class="bubble-container">
                <div class="bubble-1">
                    <span class="power-value" id="power">600 W</span>
                    <span class="power-txt">current power</span>
                </div>

                <div class="bubble-2">
                    <span class="voltage-value" id="voltage">75 V</span>
                    <span class="voltage-txt">current voltage</span>  
                </div>

                <div class="bubble-3">
                    <span class="current-value" id="current">8 A</span>
                    <span class="current-txt">electric current</span>
                </div>
            </div>
            
            <!-- <div class="statistics-container"> -->
                <div class="statiscics-content">
                    <span class="statistics-txt">Statistics</span>

                    <div class="chart-container">
                        <canvas id="weeklyProductionChart" style="display: inline-block; box-sizing: content-box;"></canvas>
                        <script src="../script/chart-script.js"></script>
                    </div>

                </div>
            <!-- </div> -->
       
        <!-- </div> -->

        <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-firestore.js"></script>

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyB-RB7B_lQManv7rVOkbLcZbPqQCoxsqbM",
              authDomain: "wind-turbine-project.firebaseapp.com",
              databaseURL: "https://wind-turbine-project-default-rtdb.europe-west1.firebasedatabase.app",
              projectId: "wind-turbine-project",
              storageBucket: "wind-turbine-project.appspot.com",
              messagingSenderId: "825323018464",
              appId: "1:825323018464:web:259be959f0a1ade4eb5885"
            };
          
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            // const app = initializeApp(firebaseConfig);
            const db = firebase.firestore();
            // db.settings({ timestampsInSnapshots: true }); 

            db.collection('WindTurbine').get().then((snapshot) => {
                snapshot.docs.forEach(doc => {
                    console.log(doc.data());
                });
            })

            var currentDate = new Date();
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth() + 1; //indeksowanie od 0
            var day = currentDate.getDate();
            var date = year+"-"+month+"-"+day
            console.log(currentDate);

            getDailyProduction(date);
            setInterval(getCurrentPower, 60000);


            function getCurrentPower() {
                return new Promise((resolve, reject) => {
                    var db = firebase.firestore();
                    var collection = db.collection('WindTurbine');
                    var realTimeReadings = collection.doc('realTime_reading');

                    realTimeReadings.get().then((doc) => {
                        if (doc.exists) {
                            var current = doc.data().current;
                            var voltage = doc.data().voltage;
                            var power = current * voltage;
                            console.log("power: ", power);
                            resolve(power);
                            document.getElementById('current').innerHTML = current + "A";
                            document.getElementById('voltage').innerHTML = voltage + "V";
                            document.getElementById('power').innerHTML = power + "W";
                            
                        } else {
                            console.log("Dokument nie istnieje");
                            reject("Dokument nie istnieje");
                        }
                    });

                });
                
            }
            function getDailyProduction(date) {
                var powerSum = 0;
                const db = firebase.firestore();
                var collection = db.collection('WindTurbine');
                var query = collection.where('date', '==', date);
                query.get().then(snapshot => {
                    snapshot.forEach(pomiar => {
                        powerSum = powerSum + pomiar.data().power;
                        console.log(pomiar.id, '=>', pomiar.data().power );
                    });
                    powerSum = powerSum/60;
                    console.log("power sum: ", powerSum/60, "Wh");
                    document.getElementById('power-sum').innerHTML = powerSum.toFixed(2) + " Wh";
                });
                
            }

            // var database = firebase.database();
            // var dataRef = database.ref('voltage/float');
            // const var_name = document.querySelector('#id_name');
            
            // var dataRef1 = database.ref('voltage/float');
            // var dataRef2 = database.ref('test/float');

            // dataRef1.on('value', function(getdata1){
            //     var vol = getdata1.val();
            //     document.getElementById('voltage').innerHTML = vol + "V";

            // })

            // dataRef2.on('value', function(getdata2){
            //     var cur = getdata2.val();
            //     document.getElementById('current').innerHTML = cur + "A";

            // })
        </script>

    </body>
</html>


